# CI-оптимизированный Dockerfile для тестов
# Слои с зависимостями кешируются отдельно от исходного кода

FROM node:20-alpine AS base
WORKDIR /app
ENV CI=true

# Кешируем слой с package files
COPY package*.json ./
RUN npm ci

# Кешируем слой с node_modules (используется для тестов)
RUN npm run build || true  # build может упасть, но node_modules остаются

# Этот target используется в compose.ci.yml
FROM base AS build
COPY . .
# Команда переопределяется в compose
CMD ["npm", "test"]
