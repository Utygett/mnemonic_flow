# Архитектурный контракт (FSD v2) для проекта — актуальная версия

Этот документ фиксирует, **как именно** держим структуру по Feature‑Sliced Design (FSD) и как мигрируем код без деградации архитектуры.

---

## 1) Слои (layers) и правило импортов

### Слои, которые используем
Используем слои FSD (без `processes`, он deprecated):

Порядок ответственности (сверху больше, снизу меньше):
- `app`
- `pages`
- `widgets`
- `features`
- `entities`
- `shared`

### Главное правило импортов (must)
Файл внутри слайса может импортировать только слайсы **строго ниже по слоям**.

Примеры:
- `pages/*` может импортировать из `widgets/*`, `features/*`, `entities/*`, `shared/*`.
- `widgets/*` может импортировать из `features/*`, `entities/*`, `shared/*`.
- `features/*` может импортировать из `entities/*` и `shared/*` (и **не может** импортировать другие `features/*`).
- `entities/*` может импортировать из `shared/*`.

Запрещено:
- `pages` импортируют `pages` (page-to-page imports).
- `widgets` импортируют `widgets` (widget-to-widget imports).
- `features` импортируют `features`.
- Импорты вверх по слоям.

Исключения:
- `app` и `shared` — это “слой=слайс”: внутри `app/*` и внутри `shared/*` сегменты могут импортировать друг друга свободно (но **app/shared не должны превращаться в доменные слои**).

---

## 2) Что лежит в каждом слое

### `shared/` — фундамент
Назначение: связь с внешним миром (API, env, 3rd‑party), базовые библиотеки и UI‑кит без бизнес‑логики.

Тут **нет доменных слайсов**, поэтому `shared/*` можно импортировать везде.

Типовые сегменты:
- `shared/api` — базовый API‑клиент, обработка ошибок, refresh-token механика (низкоуровнево).
- `shared/ui` — UI‑кит (Button/Input/Modal/MarkdownField и т.п.), без доменной логики.
- `shared/lib` — маленькие сфокусированные библиотеки (dates/text/math и т.д.), не “помойка utils”.
- `shared/config` — env, глобальные флаги, конфиги.

Запрещено:
- доменные папки в `shared` (типа `shared/cards`)
- “бесхозные” верхнеуровневые `components/hooks/types` как основные сегменты.

---

### `entities/` — доменные сущности
Назначение: понятия предметной области (Card, Deck, Group, User и т.п.).

Обычно внутри:
- `entities/<entity>/model` — типы, состояние (если есть), доменные хелперы.
- `entities/<entity>/api` — запросы, относящиеся к сущности.
- `entities/<entity>/ui` — переиспользуемые компоненты отображения сущности.

Важно:
- Сущности по умолчанию не знают друг о друге.
- Связующую бизнес‑логику держим выше (features/widgets/pages).

---

### `features/` — пользовательские действия (use-cases)
Назначение: “что пользователь делает” (создать карточку, отредактировать, логин, импортировать и т.д.).

Фича может включать:
- UI (форма / диалог)
- валидацию
- вызовы API
- локальную модель/стейт

Требования:
- Фича должна быть **сфокусированной** (не “всё подряд”).
- `features` **не импортируют** другие `features` (любая “склейка сценариев” — выше: widgets/pages).

---

### `widgets/` — крупные блоки интерфейса
Назначение: большие самодостаточные куски UI (shell/layout, tab-bar, крупные панели), особенно если они:
- переиспользуются, **или**
- сильно разгружают страницу.

**Ключевое решение проекта (обновление):**
- Табовый лейаут приложения (MainShell / MnemonicRootSwitch, нижняя навигация, PWA overlays и т.п.) — это **`widgets/main-shell`**, а не `pages/main`.

Почему:
- Это не маршрутизируемый экран, а контейнер/лейаут, который показывает разные экраны/табы.
- Widget не должен импортировать `pages/*`; он подключает нижние слои (`features/*`, `entities/*`, `shared/*`).

---

### `pages/` — страницы/экраны
Назначение: маршрутизируемые экраны (Auth, Onboarding, Home, Study, Stats, Profile, и т.п.).

Содержимое:
- UI страницы
- загрузки/ошибки
- сборка виджетов/фич
- минимальная “клейка”

Страницы могут содержать заметный объём кода, если команде легко ориентироваться.

Запрещено:
- Импорты из других `pages/*` напрямую (page-to-page).

---

### `app/` — глобальная инфраструктура приложения
Назначение:
- провайдеры (AuthProvider)
- конфиг роутинга (AppRouter)
- глобальные стили
- entrypoint
- интеграции типа PWA/analytics

Правило:
- `app` — не про домены. Там нельзя разводить “бизнес-слайсы”, только инфраструктуру и композицию верхнего уровня.

---

## 3) Сегменты внутри слайса (standard)

Для `pages/widgets/features/entities` используем одинаковые имена сегментов:
- `ui/` — React‑компоненты (View), максимально без side‑effects.
- `model/` — состояние/хуки, валидация, бизнес‑правила, селекторы.
- `api/` — запросы/мутации (на уровне сущности или сценария).
- `lib/` — локальные утилиты только этого слайса.
- `config/` — локальные флаги/конфиги.

Не заводим верхнеуровневые `hooks/`, `types/`, `components/` как обязательные сегменты (допускается только внутри `ui/` как подпапки).

---

## 4) Public API и правила экспорта

### Правило “вход только через index.ts”
Каждый слайс обязан иметь `index.ts` (Public API).

Импортировать слайс снаружи можно **только** так:
- `import { X } from "features/cards-create";`
- `import { DeckCard } from "entities/deck";`
- `import { MainShellContainer } from "widgets/main-shell";`

Запрещено (deep-imports):
- `import { X } from "features/cards-create/ui/CreateCardView";`

Почему:
- Можно свободно переставлять файлы внутри слайса без переписывания импортов по всему проекту.
- Меньше “ломающихся” путей при рефакторинге.

---

## 5) Правила добавления/редактирования файлов

### Добавляем новое: чек‑лист
1) Определи ответственность:
- фундамент/общая библиотека → `shared`
- сущность → `entities/<name>`
- действие пользователя → `features/<name>`
- большой блок UI → `widgets/<name>`
- экран/роут → `pages/<name>`
- глобальная инфраструктура → `app`

2) Положи код в правильный сегмент (`ui/model/api/lib/config`).

3) Экспортируй через `index.ts` слайса (Public API).

4) Проверь импорты: только вниз по слоям (кроме `app/shared`).

---

## 6) Принятые решения для проекта (фиксируем)

- `processes` не используем (deprecated).
- `app` и `shared` — без бизнес‑доменных слайсов, только сегменты.
- Новый код: только через Public API слайса.
- `pages` не импортируют `pages`.
- Tabовый shell приложения — `widgets/main-shell`.
- Временные прокси/реэкспорты допустимы на время миграции, но должны удаляться ближайшими PR.

---

## 7) Миграция (как переносим текущую реализацию)

Текущее направление миграции:
- Перенести реализацию из временных мест и убрать legacy-папки.
- Везде перейти на Public API (`.../index.ts`), запретить deep-imports.
